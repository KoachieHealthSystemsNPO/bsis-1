<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <changeSet id="20170626-1535" author="tumijacob">
    <comment>This change set: 1) Adds a foreign key testBatch_id to Donation 2) Updates the foreign key testBatch_id on Donation with the right values</comment>
        <addColumn tableName="Donation">
            <column name="testBatch_id" type="binary(16)">
                <constraints nullable="true" foreignKeyName="fk_Donation_TestBatch" references="TestBatch(id)"/>
            </column>
        </addColumn>
        <sql dbms="mysql">
          ALTER TABLE Donation ADD testBatch_id_text varchar(36) GENERATED ALWAYS AS (LCASE(CONCAT_WS('-', 
            HEX(SUBSTR(testBatch_id,  1, 4)),
            HEX(SUBSTR(testBatch_id,  5, 2)),
            HEX(SUBSTR(testBatch_id,  7, 2)),
            HEX(SUBSTR(testBatch_id,  9, 2)),
            HEX(SUBSTR(testBatch_id, 11)) )))
          VIRTUAL AFTER testBatch_id;
        </sql>
         <!-- Set the new foreign key in Donation with the correct testBatch_id. -->
        <sql>
          UPDATE Donation d
          LEFT JOIN DonationBatch db ON (d.donationBatch_id = db.id)
          SET d.testBatch_id = db.testBatch_id
        </sql>
  </changeSet>
</databaseChangeLog>