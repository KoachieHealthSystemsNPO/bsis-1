<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <changeSet id="20170324-1154"  author="micnice">
    <comment>This is one large change set that migrates the OrderFormItem table from an integer id primary key
    to a UUID of type BINARY(16). </comment>

      <addColumn tableName="OrderFormItem">
          <column name="id_temp" type="BIGINT" afterColumn="id"/>
      </addColumn>

      <addColumn tableName="OrderFormItem_AUD">
          <column name="id_temp" type="BIGINT" afterColumn="id"/>
      </addColumn>

      <sql>
          UPDATE OrderFormItem
          SET id_temp = id;
      </sql>

      <sql>
          UPDATE OrderFormItem_AUD
          SET id_temp = id;
      </sql>

      <!-- Remove auto increment from the existing id column -->
      <modifyDataType
              columnName="id"
              newDataType="BIGINT(20)"
              schemaName="bsis"
              tableName="OrderFormItem"/>

      <dropPrimaryKey
              constraintName="PRIMARY"
              schemaName="bsis"
              tableName="OrderFormItem"/>
      <addPrimaryKey
              columnNames="id"
              constraintName="PRIMARY"
              schemaName="bsis"
              tableName="OrderFormItem"/>

      <modifyDataType columnName="id"
                      newDataType="BINARY(16)"
                      schemaName="bsis"
                      tableName="OrderFormItem"/>

      <modifyDataType columnName="id"
                      newDataType="BINARY(16)"
                      schemaName="bsis"
                      tableName="OrderFormItem_AUD"/>

      <sql>
          UPDATE OrderFormItem
          SET id = GENERATEBINARYUUID();
      </sql>

      <sql dbms="mysql">
          ALTER TABLE OrderFormItem ADD id_text varchar(36) GENERATED ALWAYS AS (LCASE(CONCAT_WS('-',
          HEX(SUBSTR(id,  1, 4)),
          HEX(SUBSTR(id,  5, 2)),
          HEX(SUBSTR(id,  7, 2)),
          HEX(SUBSTR(id,  9, 2)),
          HEX(SUBSTR(id, 11)) )))
          VIRTUAL AFTER id
      </sql>

      <sql dbms="mysql">
          ALTER TABLE OrderFormItem_AUD ADD id_text varchar(36) GENERATED ALWAYS AS (LCASE(CONCAT_WS('-',
          HEX(SUBSTR(id,  1, 4)),
          HEX(SUBSTR(id,  5, 2)),
          HEX(SUBSTR(id,  7, 2)),
          HEX(SUBSTR(id,  9, 2)),
          HEX(SUBSTR(id, 11)) )))
          VIRTUAL AFTER id
      </sql>

      <sql>
          UPDATE OrderFormItem_AUD AS updateTable
          LEFT JOIN OrderFormItem AS joinTable ON (updateTable.id_temp = joinTable.id_temp)
          SET
          updateTable.id = joinTable.id
          WHERE joinTable.id IS NOT null
      </sql>

      <dropColumn columnName="id_temp"
                  schemaName="bsis"
                  tableName="OrderFormItem"/>
      <dropColumn columnName="id_temp"
                  schemaName="bsis"
                  tableName="OrderFormItem_AUD"/>
  </changeSet>
</databaseChangeLog>
